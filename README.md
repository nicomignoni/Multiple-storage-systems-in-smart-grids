# Multiple storage systems in smart grids
This repo contains the MATLAB code used in the MSc thesis _"Control techniques for multiple energy storage systems in smart grids"_.

The main idea is to consider the energy storage as a service provided by an independent economical agents, i.e., the _providers_. _Prosumers_ can than decide whether to sell the exceeding energy to the _retailer_ or store it. 

<p align="center">
  <img src="img/framework.png" align="center"></img>
</p>

## Prosumer and provider models
The model for the <img src="https://latex.codecogs.com/gif.latex?%5Cinline%20i"></img> prosumer comprises the cost function <img src="https://latex.codecogs.com/gif.latex?%5Cinline%20J_%7B%5Cmathcal%7BP%7D%2Ci%7D"></img>, i.e.,

<div align="center"><img src="https://latex.codecogs.com/gif.latex?J_%7B%5Cmathcal%7BP%7D%2Ci%7D%20%3D%20%5Csum_%7Bt%20%5Cin%20%5Cmathcal%7BT%7D%7D%20%5Cbigg%5B%20%5Cunderbrace%7BC_t%20p%5E%5Cuparrow_%7Bit%7D%20-%20R_t%20p%5E%5Cdownarrow_%7Bit%7D%20&plus;%20L_t%20s_%7Bit%7D%7D_%7B%5Ctext%7BCost/revenue%20and%20storage%20fee%7D%7D%20&plus;%20%5Cunderbrace%7B%5Cfrac%7B1%7D%7B2%7D%20%5Cxi_i%20%5CBig%28p%5E%7B%5Cuparrow2%7D_%7Bit%7D%20&plus;%20p%5E%7B%5Cdownarrow2%7D_%7Bit%7D%20&plus;%20d%5E%7B%5Cuparrow2%7D_%7Bit%7D%20&plus;%20d%5E%7B%5Cdownarrow2%7D_%7Bit%7D%7D_%7B%5Ctext%7BEnergy%20transmission%20costs%7D%7D%20%5CBig%29%20%5Cbigg%5D"></div>

subject to the constraints set 

<div align="center"><img src="https://latex.codecogs.com/gif.latex?%5Cmathcal%7BK%7D_%7B%5Cmathcal%7BP%7D%2Ci%7D%3D%20%5Cbegin%7Bcases%7D%20G_%7Bit%7D%20-%20D_%7Bit%7D%20&plus;%20d%5E%5Cuparrow_%7Bit%7D%20-%20d%5E%5Cdownarrow_%7Bit%7D%20&plus;%20p%5E%5Cuparrow_%7Bit%7D%20-%20p%5E%5Cdownarrow_%7Bit%7D%20%3D%200%20%5C%5C%20s_%7Bit%7D%20%3D%20%5Calpha%20s_%7Bi%2Ct-1%7D%20&plus;%20%5Ceta%5E%5Cuparrow%20d%5E%5Cdownarrow_%7Bit%7D%20-%20%5Ceta%5E%5Cdownarrow%20d%5E%5Cuparrow_%7Bit%7D%20%5C%5C%20s%5E%5Ctext%7Binit%7D_%7Bi%7D%20%3D%20s_%7BiT%7D%20%5C%5C%20d%5E%5Cuparrow_%7Bit%7D%20%5Cleq%20d%5E%5Ctext%7Bmax%7D%20%5C%5C%20d%5E%5Cdownarrow_%7Bit%7D%20%5Cleq%20d%5E%5Ctext%7Bmax%7D%20%5C%5C%20p%5E%5Cdownarrow_%7Bit%7D%20%5Cleq%20p%5E%5Ctext%7Bmax%7D%20%5C%5C%20p%5E%5Cuparrow_%7Bit%7D%20%5Cleq%20p%5E%5Ctext%7Bmax%7D%20%5C%5C%20%5Cboldsymbol%7Bv%7D_%7B%5Cmathcal%7BP%7D%2Ci%7D%20%5Cgeq%20%5Cboldsymbol%7B0%7D%20%5Cend%7Bcases%7D"></div> 

where <img src="https://latex.codecogs.com/gif.latex?G_%7Bit%7D"></img> is the energy generated by the <img src="https://latex.codecogs.com/gif.latex?%5Cinline%20i"></img> prosumer, <img src="https://latex.codecogs.com/gif.latex?D_%7Bit%7D"></img> is its demand, <img src="https://latex.codecogs.com/gif.latex?d%5E%5Cuparrow_%7Bit%7D"></img> is the energy retrieved from providers' storage systems, while <img src="https://latex.codecogs.com/gif.latex?d%5E%5Cdownarrow_%7Bit%7D"></img> is the energy transferred to providers. The amount of energy bought from the provider is <img src="https://latex.codecogs.com/gif.latex?p%5E%5Cuparrow_%7Bit%7D"></img>, while the amount sold is <img src="https://latex.codecogs.com/gif.latex?p%5E%5Cdownarrow_%7Bit%7D"></img>. The amount of energy stored is <img src="https://latex.codecogs.com/gif.latex?s%5E%5Cdownarrow_%7Bit%7D"></img>. Vector <img src="https://latex.codecogs.com/gif.latex?%5Cboldsymbol%7Bv%7D_%7B%5Cmathcal%7BP%7D%2C%20i%7D"></img> contains the previously listed variables. Parameters <img src="https://latex.codecogs.com/gif.latex?C_%7Bt%7D"></img>, <img src="https://latex.codecogs.com/gif.latex?R_%7Bt%7D"></img>, <img src="https://latex.codecogs.com/gif.latex?L_%7Bt%7D"></img> are, respectively, the energy buying and selling prices, and the storage service price.

As for the model for the <img src="https://latex.codecogs.com/gif.latex?%5Cinline%20j"></img> provider, it comprises the cost function <img src="https://latex.codecogs.com/gif.latex?%5Cinline%20J_%7B%5Cmathcal%7BS%7D%2Cj%7D"></img>, i.e.,

<div align="center"><img src="https://latex.codecogs.com/gif.latex?J_%7B%5Cmathcal%7BS%7D%2Cj%7D%20%3D%20%5Csum_%7Bt%20%5Cin%20%5Cmathcal%7BT%7D%7D%20%5Cbigg%5B%20%5Cunderbrace%7B%5Cfrac%7B1%7D%7B2%7D%20%5Czeta_j%20%28q%5E%5Cuparrow_%7Bjt%7D%20&plus;%20q%5E%5Cdownarrow_%7Bjt%7D%29%5E2%7D_%7B%5Ctext%7BStorage%20degradation%20costs%7D%7D%20-%20%5Cunderbrace%7BL_t%20b_%7Bjt%7D%7D_%7B%5Ctext%7BRevenues%7D%7D%20%5Cbigg%5D"></div>

subject to the constraints set

<div align="center"> <img src="https://latex.codecogs.com/gif.latex?%5Cmathcal%7BK%7D_%7B%5Cmathcal%7BS%7D%2Cj%7D%3D%20%5Cbegin%7Bcases%7D%20b_%7Bjt%7D%20%3D%20%5Calpha%20b_%7Bj%2Ct-1%7D%20&plus;%20%5Ceta%5E%5Cuparrow%20q%5E%5Cuparrow_%7Bjt%7D%20-%20%5Ceta%5E%5Cdownarrow%20q%5E%5Cdownarrow_%7Bjt%7D%20%5C%5C%20b_%7Bjt%7D%20%5Cleq%20b%5E%5Ctext%7Bmax%7D_j%20%5C%5C%20q%5E%5Cuparrow_%7Bjt%7D%20%5Cleq%20q%5E%5Ctext%7Bmax%7D%20%5C%5C%20q%5E%5Cdownarrow_%7Bjt%7D%20%5Cleq%20q%5E%5Ctext%7Bmax%7D%20%5C%5C%20%5Cboldsymbol%7Bv%7D_%7B%5Cmathcal%7BS%7D%2Cj%7D%20%5Cgeq%20%5Cboldsymbol%7B0%7D%20%5Cend%7Bcases%7D"></div>

where <img align="center"><img src="https://latex.codecogs.com/gif.latex?q%5E%5Cuparrow_%7Bjt%7D"></img> is the energy received by prosumers, <img src="https://latex.codecogs.com/gif.latex?q%5E%5Cdownarrow_%7Bjt%7D"></img> is the energy retrieved by prosumers, <img src="https://latex.codecogs.com/gif.latex?b_%7Bjt%7D"></img> is the storage system charging level. Vector <img src="https://latex.codecogs.com/gif.latex?%5Cboldsymbol%7Bv%7D_%7B%5Cmathcal%7BS%7D%2C%20j%7D"></img> contains the previously listed variables. The degradation rate is <img src="https://latex.codecogs.com/gif.latex?%5Czeta_%7Bjt%7D"></div>.  

## Implementative approaches
### Centralized
The centralized approach consists of a grand coalition resulting from the union of the prosumers' and providers' communities. A _community manager_ solves the ooptimization problem on behalf of all agents. 
<p align="center">
  <img src="img/prosumer-provider-full.png" align="center"></img>
</p>

The objective function is <img src="https://latex.codecogs.com/gif.latex?J%5E%7B%28c%29%7D"></img> results from the sum of the objective functions of all agents, i.e.,
<p align="center">
  <img src="https://latex.codecogs.com/gif.latex?J%5E%7B%28c%29%7D%20%3D%20%5Csum_%7Bi%20%5Cin%20%5Cmathcal%7BP%7D%7D%20J_%7B%5Cmathcal%7BP%7D%2Ci%7D%20&plus;%20%5Csum_%7Bj%20%5Cin%20%5Cmathcal%7BS%7D%7D%20J_%7B%5Cmathcal%7BS%7D%2Cj%7D" align="center"></img>
</p>
subject to 
<p align="center">
  <img src="https://latex.codecogs.com/gif.latex?%5Cmathcal%7BK%7D_%5Cmathcal%7BC%7D%20%3D%20%5Cmathcal%7BK%7D_%7B%5Ctext%7BA%7D%7D%20%5Ccup%20%5Cleft%28%20%5Cbigcup_%7Bi%20%5Cin%20%5Cmathcal%7BP%7D%7D%20%5Cmathcal%7BK%7D_%7B%5Cmathcal%7BP%7D%2Ci%7D%20%5Cright%29%20%5Ccup%20%5Cleft%28%20%5Cbigcup_%7Bj%20%5Cin%20%5Cmathcal%7BS%7D%7D%20%5Cmathcal%7BK%7D_%7B%5Cmathcal%7BS%7D%2Cj%7D%20%5Cright%29" align="center"></img>
</p>

where <img src="https://latex.codecogs.com/gif.latex?%5Cmathcal%7BK%7D_%7B%5Ctext%7BA%7D%7D"></img> is
<p align="center">
  <img src="https://latex.codecogs.com/gif.latex?%5Cmathcal%7BK%7D_%7B%5Ctext%7BA%7D%7D%3D%20%5Cbegin%7Bcases%7D%20%5Cdisplaystyle%20%5Csum_%7Bi%20%5Cin%20%5Cmathcal%7BP%7D%7D%20d%5E%5Cuparrow_%7Bit%7D%20-%20%5Csum_%7Bj%20%5Cin%20%5Cmathcal%7BS%7D%7D%20q%5E%5Cdownarrow_%7Bjt%7D%20%3D%200%20%5C%5C%20%5Cdisplaystyle%20%5Csum_%7Bi%20%5Cin%20%5Cmathcal%7BP%7D%7D%20d%5E%5Cdownarrow_%7Bit%7D%20-%20%5Csum_%7Bj%20%5Cin%20%5Cmathcal%7BS%7D%7D%20q%5E%5Cuparrow_%7Bjt%7D%20%3D%200%20%5Cend%7Bcases%7D">
</p>

This approach returns an optimal and paretian solution for the coalition, but is not practically conveneient to realize. Therefore, the decentralized and distributed approaches are formulated as alternatives.

### Decentralized
In the decentralized approach the problem is formulated as a non-cooperative game where its solution corresponds to a Nash equilibrium point. The iterative algorithm consists of every agent solves its optimization problem and then communicates the state of its energy flow variables to a _coordinator_. Therefore, the latter can calculate the aggregate energy flow values and, consequently, the penalty factors <img src="https://latex.codecogs.com/gif.latex?\inline&space;\lambda^{(\tau)}_{t}"></img> and <img src="https://latex.codecogs.com/gif.latex?\inline&space;\psi^{(\tau)}_{t}"></img>, which guarantee the convergence of the energy flow constraints. Penalty factors are, then, are boradcasted to all agents, in order for them to calculate the penalty regularizers <img src="https://latex.codecogs.com/gif.latex?\inline&space;m_{\mathcal{P},i}"></img> and <img src="https://latex.codecogs.com/gif.latex?\inline&space;m_{\mathcal{S},j}"></img>, which are added to the objective function.
<p align="center">
  <img src="img/decentralized.png" align="center"></img> 
</p>

### Distributed
In the distributed approach, the communication and energy transfer network is modelled as a bipartite graph. Each agent solves its own optimization problem and broadcasts the state of its energy flow variables to the nodes in its neighborhood. Therefore, penalty factors and regularizers are autonomously updated, without the need of a coordinator.
<p align="center">
  <img src="img/distributed.png" align="center"></img>
</p>
